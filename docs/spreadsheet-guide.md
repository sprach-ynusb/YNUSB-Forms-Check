# スプレッドシート設定ガイド

このガイドでは、提出状況ダッシュボードで使用するスプレッドシートの設定方法を説明します。

## 1. 管理用シート（GOOGLE_MANAGEMENT_SHEET_ID）

管理用シートには、以下の2つのシートが必要です。

### 1.1 「名簿」シート

名簿シートには、ユーザー情報と権限情報を記載します。

#### 必須列

| 列名 | 必須 | 説明 | 例 |
|------|------|------|-----|
| **名前** | ✅ | ユーザーの名前（必須） | `田中太郎` |
| **メールアドレス** | ⚠️ | ユーザーのメールアドレス（任意、認証用） | `user1@example.com` |
| **権限** | ✅ | ユーザーの権限（必須） | `一般`、`チーム代表者`、`管理者` |
| **チーム** | ⚠️ | チーム名（チーム代表者の場合に使用） | `チームA`、`開発チーム` |

#### 権限の値

- **一般**: 自分の提出状況のみ表示
- **チーム代表者**: 自分のチームメンバー全員の提出状況を表示
- **管理者**（または`フォーム作成者`）: 全員の提出状況を表示

#### 名簿シートの例

```
| メールアドレス        | 名前     | 権限       | チーム    |
|---------------------|---------|-----------|----------|
| user1@example.com   | 田中太郎 | 一般       |          |
| user2@example.com   | 佐藤花子 | チーム代表者 | チームA   |
| user3@example.com   | 鈴木一郎 | 一般       | チームA   |
| user4@example.com   | 山田次郎 | 管理者     |          |
| admin@example.com   | 管理者   | フォーム作成者 |        |
```

**注意事項:**
- **名前列は必須です**（列名に「名前」「name」「氏名」を含む）
- メールアドレス列は任意です（列名に「メール」「email」「e-mail」を含む、認証用）
- 権限列は必須です（列名に「権限」「role」「役割」を含む）
- チーム列は任意です（列名に「チーム」「team」「グループ」を含む）
- **提出状況の判定は名前で行われます**（名簿の名前とフォーム回答の名前を照合）
- 名前は空白を除去して比較されます（例: "田中 太郎" と "田中太郎" は同じとして扱われます）

### 1.2 「フォーム一覧」シート

フォーム一覧シートには、監視するフォームのIDまたはシート名と名前を記載します。

#### 必須列

| 列名 | 説明 | 例 |
|------|------|-----|
| **ID/シート名**（第1列） | フォームの回答シートIDまたはシート名（必須） | `1abc123def456...` または `アンケート1` |
| **名前**（第2列以降） | フォーム名（任意） | `アンケート1`、`健康診断フォーム` |

#### 方法1: 別々のスプレッドシートを使用する場合

各フォームを別々のスプレッドシートにリンクする場合：

```
| ID（スプレッドシートID）              | フォーム名           |
|-------------------------------------|-------------------|
| 1abc123def456ghi789jkl012mno345pqr | アンケート1         |
| 2def456ghi789jkl012mno345pqr678stu | 健康診断フォーム      |
| 3ghi789jkl012mno345pqr678stu901vwx | 研修アンケート       |
```

**スプレッドシートIDの取得方法:**
1. Googleスプレッドシートを開く
2. URLを確認: `https://docs.google.com/spreadsheets/d/{スプレッドシートID}/edit`
3. `{スプレッドシートID}`の部分をコピー

#### 方法2: 同じスプレッドシートの異なるシートを使用する場合（推奨）

すべてのフォームを同じスプレッドシート（管理用シートと同じ）の異なるシートにリンクする場合：

```
| シート名      | フォーム名           |
|-------------|-------------------|
| アンケート1   | アンケート1         |
| 健康診断      | 健康診断フォーム      |
| 研修アンケート | 研修アンケート       |
```

**メリット:**
- ✅ スプレッドシートIDをコピーする必要がない
- ✅ 管理が簡単（1つのスプレッドシートで完結）
- ✅ サービスアカウントの共有設定が1回で済む

**設定方法:**
1. 管理用シートと同じスプレッドシートに、各フォームを異なるシートにリンク
2. フォーム一覧シートの第1列に、シート名を記載（スプレッドシートIDではなく）
3. システムが自動的に管理用シートIDを使用します

**注意事項:**
- 第1列がフォームID/シート名として使用されます
- シート名の場合は、短い文字列（50文字未満）として認識されます
- ID列のヘッダー行は「ID」「シート」「sheet」を含む必要があります（オプション）
- フォーム名は第2列以降から自動検出されます（「名前」「name」「フォーム」を含む列）

## 2. フォーム回答シート（各フォーム）

各フォームの回答シートには、Googleフォームの回答が自動的に記録されます。

### Googleフォームをスプレッドシートにリンクする方法（推奨）

1. **Googleフォームを作成**
   - [Googleフォーム](https://forms.google.com)で新しいフォームを作成
   - メールアドレスを収集する質問を追加（「短答形式」または「メールアドレス」タイプ）

2. **既存のスプレッドシートにリンク**
   - フォームの右上の「回答」タブをクリック
   - 「スプレッドシートにリンク」をクリック
   - 「既存のスプレッドシートを選択」を選択
   - または「新しいスプレッドシートを作成」を選択して後で共有設定

3. **スプレッドシートIDを取得**
   - リンクしたスプレッドシートを開く
   - URLからスプレッドシートIDをコピー: `https://docs.google.com/spreadsheets/d/{スプレッドシートID}/edit`

4. **フォーム一覧シートに登録**
   - 管理用シートの「フォーム一覧」シートに、取得したスプレッドシートIDを記載

### 必須列

| 列名 | 説明 | 例 |
|------|------|-----|
| **名前** | 回答者の名前（必須、最初の質問） | `田中太郎` |

### フォーム回答シートの例

Googleフォームをスプレッドシートにリンクすると、以下のような形式で自動的に記録されます：

```
| タイムスタンプ              | 名前     | 質問2 | 質問3 | ... |
|---------------------------|---------|-------|-------|-----|
| 2024/01/15 10:30:00      | 田中太郎 | 回答2  | 回答3  | ... |
| 2024/01/15 11:45:00      | 佐藤花子 | 回答2  | 回答3  | ... |
| 2024/01/16 09:15:00      | 鈴木一郎 | 回答2  | 回答3  | ... |
```

**重要:**
- 名前列は必須です（列名に「名前」「name」「氏名」「お名前」などを含む）
- システムはヘッダー行から名前列を自動検出します（どの位置でも検出可能）
- 名前列の検出優先順位:
  1. ヘッダー行から「名前」「name」「氏名」「お名前」「姓名」「フルネーム」などを含む列を検出
  2. より緩い検索で「名」または「name」を含む列を検出
  3. それでも見つからない場合、第2列（タイムスタンプの次）をフォールバックとして使用
- 複数のシートがある場合、すべてのシートから名前を取得します
- 名前は空白を除去して比較されます（例: "田中 太郎" と "田中太郎" は同じとして扱われます）
- 名簿の名前とフォーム回答の名前を照合して提出状況を判定します
- **名前列はどの位置にあっても検出されます**（第2列である必要はありません）

## 3. 設定の流れ（推奨手順）

### ステップ1: 管理用シートの作成

1. 新しいGoogleスプレッドシートを作成
2. 「名簿」シートを作成し、ユーザー情報を記載
3. 「フォーム一覧」シートを作成（後でフォームIDを記載）
4. スプレッドシートIDを`.env.local`の`GOOGLE_MANAGEMENT_SHEET_ID`に設定

### ステップ2: Googleフォームの作成とリンク

#### 方法A: 同じスプレッドシートの異なるシートにリンク（推奨）

1. **Googleフォームを作成**
   - [Googleフォーム](https://forms.google.com)で新しいフォームを作成
   - メールアドレスを収集する質問を追加（「短答形式」または「メールアドレス」タイプ）

2. **管理用シートにリンク**
   - フォームの右上の「回答」タブをクリック
   - 「スプレッドシートにリンク」をクリック
   - 「既存のスプレッドシートを選択」を選択
   - **管理用シートを選択**
   - 新しいシートが自動作成されます（シート名を変更可能）

3. **フォーム一覧に登録**
   - 管理用シートの「フォーム一覧」シートに、**シート名**を記載
   - フォーム名も記載すると分かりやすくなります
   - 例: `アンケート1`（スプレッドシートIDではなくシート名）

#### 方法B: 別々のスプレッドシートにリンク

1. **Googleフォームを作成**
   - [Googleフォーム](https://forms.google.com)で新しいフォームを作成
   - メールアドレスを収集する質問を追加（「短答形式」または「メールアドレス」タイプ）

2. **スプレッドシートにリンク**
   - フォームの右上の「回答」タブをクリック
   - 「スプレッドシートにリンク」をクリック
   - 「既存のスプレッドシートを選択」または「新しいスプレッドシートを作成」
   - リンクしたスプレッドシートのURLからスプレッドシートIDをコピー

3. **フォーム一覧に登録**
   - 管理用シートの「フォーム一覧」シートに、取得したスプレッドシートIDを記載
   - フォーム名も記載すると分かりやすくなります

### ステップ3: サービスアカウントの共有設定

1. **管理用シートの共有**
   - 管理用シートを開く
   - 右上の「共有」ボタンをクリック
   - サービスアカウントのメールアドレス（`GOOGLE_SERVICE_ACCOUNT_EMAIL`）を追加
   - 権限は「閲覧者」でOK

2. **各フォーム回答シートの共有**
   - 各フォームの回答シート（リンクしたスプレッドシート）を開く
   - 右上の「共有」ボタンをクリック
   - サービスアカウントのメールアドレスを追加
   - 権限は「閲覧者」でOK

### ステップ4: 動作確認

1. ダッシュボードにアクセス
2. `/dashboard/submissions`で提出状況を確認
3. フォームに回答を送信して、提出状況が更新されることを確認

### 補足: Googleフォームで名前を収集する方法

Googleフォームで名前を確実に収集するには：

1. **名前の質問を追加**
   - 「質問を追加」→「短答形式」を選択
   - 質問文に「お名前を入力してください」と記載
   - 列名が「名前」「name」「氏名」「お名前」などになるように設定
   - **質問の順序は問いません**（どの位置でも検出されます）

2. **名前の入力形式**
   - フルネーム（例: "田中太郎"）
   - 姓と名を分ける場合も対応可能（空白を除去して比較）

3. **推奨される列名**
   - 「名前」
   - 「name」
   - 「氏名」
   - 「お名前」
   - 「姓名」
   - 「フルネーム」
   - 「full name」

**重要:**
- システムはヘッダー行から名前列を自動検出します
- 名前列はどの位置にあっても検出されます（第2列である必要はありません）
- 名簿シートの名前と完全一致する必要があります（空白は無視されます）
- 名前列が見つからない場合、コンソールに警告が表示されます

## 4. 列名の自動検出

システムは以下の列名パターンを自動的に検出します：

### メールアドレス列
- 「メール」「email」「e-mail」を含む列名

### 名前列
- 「名前」「name」「氏名」を含む列名

### 権限列
- 「権限」「role」「役割」を含む列名

### チーム列
- 「チーム」「team」「グループ」を含む列名

### フォーム名列
- 「名前」「name」「フォーム」を含む列名

## 5. トラブルシューティング

### データが表示されない場合

1. **サービスアカウントの共有設定を確認**
   - 管理用シートと各フォーム回答シートにサービスアカウントが共有されているか確認

2. **列名を確認**
   - メールアドレス列が正しく検出されているか確認
   - 列名に「メール」「email」「e-mail」が含まれているか確認

3. **スプレッドシートIDを確認**
   - フォーム一覧シートのIDが正しいか確認
   - URLから正しくIDを取得できているか確認

4. **名簿のメールアドレスを確認**
   - 名簿シートのメールアドレスが正しい形式か確認
   - `@`が含まれているか確認

### 権限が正しく表示されない場合

1. **権限列の値を確認**
   - 「一般」「チーム代表者」「管理者」のいずれかが設定されているか確認
   - 大文字小文字は区別されませんが、正確な文字列を使用してください

2. **チーム列の値を確認**
   - チーム代表者の場合、チーム列に値が設定されているか確認

## 6. サンプルデータ

### 名簿シートのサンプル

```csv
メールアドレス,名前,権限,チーム
user1@example.com,田中太郎,一般,
user2@example.com,佐藤花子,チーム代表者,チームA
user3@example.com,鈴木一郎,一般,チームA
user4@example.com,山田次郎,管理者,
admin@example.com,管理者,フォーム作成者,
```

### フォーム一覧シートのサンプル

```csv
ID,フォーム名
1abc123def456ghi789jkl012mno345pqr,アンケート1
2def456ghi789jkl012mno345pqr678stu,健康診断フォーム
3ghi789jkl012mno345pqr678stu901vwx,研修アンケート
```

